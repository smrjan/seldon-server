#!/bin/bash

set -o nounset
set -o errexit

#modify import_actions_utils.py in seldon-control
vi /opt/conda/lib/python2.7/site-packages/seldon-2.0.1-py2.7.egg/seldon/cli/import_actions_utils.py1
rm /opt/conda/lib/python2.7/site-packages/seldon-2.0.1-py2.7.egg/seldon/cli/import_actions_utils.py
mv /opt/conda/lib/python2.7/site-packages/seldon-2.0.1-py2.7.egg/seldon/cli/import_actions_utils.py1 /opt/conda/lib/python2.7/site-packages/seldon-2.0.1-py2.7.egg/seldon/cli/import_actions_utils.py
cat /opt/conda/lib/python2.7/site-packages/seldon-2.0.1-py2.7.egg/seldon/cli/import_actions_utils.py


#the value type must be one of 'double', 'string', 'date' or an object
#Ptotal actions 664436
#total items 19415
#total users 301437
#total actions 586220
#total items 19407
#total users 256909

{item:-1323853339,score:0.08861735}

#docker run -it seldonio/seldon-control:2.0.5_v1 bash
#kubectl exec -it seldon-control bash
docker ps | grep seldon-control
docker cp seldon-spark-1.3.8-jar-with-dependencies.jar 78be5304e984:/home/seldon/libs
docker cp seldon-spark-1.3.8.jar 78be5304e984:/home/seldon/libs/seldon-spark.jar
docker cp seldon.conf 7e4b15b08c74:/home/seldon/seldon.conf
docker cp seldon.conf 7e4b15b08c74:/root/.seldon/seldon.conf
ctrl+p, ctrl+q
docker commit 78be5304e984 seldonio/seldon-control:2.0.5_v1
kubectl delete -f ~/seldon-server/kubernetes/conf/control.json
kubectl apply -f ~/seldon-server/kubernetes/conf/control.json

docker run -it seldonio/seldon-server:1.3.8 bash
    >> docker cp seldon-server-1.3.8.war 5d2e20a7b305:/home/seldon/ROOT/
cd /home/seldon/ROOT/
ls
rm -rf META-INF/
rm -rf WEB-INF/
unzip seldon-server-1.3.8.war
rm seldon-server-1.3.8.war
ctrl+p, ctrl+q
docker commit a2e2d270d54f seldonio/seldon-server:1.3.8
kubectl delete -f ~/seldon-server/kubernetes/conf/dev/server.json
kubectl apply -f ~/seldon-server/kubernetes/conf/dev/server.json

kubectl get pods
kubectl delete pod seldon-server-4192844183-msudx


kubectl exec -it seldon-control bash
mysql -u root -h mysql -pmypass -b -e 'drop database ahalife;'
rm -rf /seldon-data/seldon-models/ahalife
rm -rf /seldon-data/conf/zkroot/all_clients/ahalife
exit

scp -i ~/security/AWS_QA.pem attr.json items.csv users.csv actions.csv ubuntu@54.205.194.231:/home/ubuntu

docker ps |grep seldon-control
docker cp attr.json a0210bc31548:/home/seldon
docker cp items.csv a0210bc31548:/home/seldon
docker cp users.csv a0210bc31548:/home/seldon
docker cp actions.csv a0210bc31548:/home/seldon

seldon-cli client --action setup --client-name ahalife --db-name ClientDB
seldon-cli attr --action apply --client-name ahalife --json attr.json
seldon-cli import --action items --client-name ahalife --file-path items.csv
seldon-cli import --action users --client-name ahalife --file-path users.csv
seldon-cli import --action actions --client-name ahalife --file-path actions.csv


seldon-cli model --action add --client-name ahalife --model-name mahout
seldon-cli rec_alg  --action add --client-name ahalife --recommender-name mahoutUBRecommender
seldon-cli model --action add --client-name ahalife --model-name matrix-factorization
seldon-cli client --action zk_push
seldon-cli client --action zk_pull
seldon-cli model --action train --client-name ahalife --model-name matrix-factorization
seldon-cli rec_alg  --action add --client-name ahalife --recommender-name recentMfRecommender
seldon-cli rec_alg --action commit --client-name ahalife
