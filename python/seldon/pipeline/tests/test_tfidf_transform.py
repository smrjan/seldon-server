import unittest
from seldon.pipeline import tfidf_transform as tf
import pandas as pd
from sklearn.pipeline import Pipeline
from sklearn.externals import joblib
import logging


class Test_tfidf_transform(unittest.TestCase):

    def test_sklearn_pipeline(self):
                df = pd.DataFrame([{"likeids": [102313626475894, 110544635673389, 125327794232468, 1381292875499997, 1405744859651437, 1410444839224829, 143981935773732, 1461778597368720, 159634840722133, 1606136206319782, 1617969055108441, 175338329150218, 208633805894647, 244944385603396, 245732105485076, 264050273731539, 302410296457933, 316001081653, 379092115616379, 388308794577146, 430801740267217, 446108528831354, 447497665393027, 450086458346414, 470402606305707, 488128054598370, 508960455844413, 518468471599787, 56531631380, 67920382572, 7310480740, 863556617025433, 943587665656008],},{"likeids": [100318233349756, 111541275541080, 118478001539872, 1392733037644503, 14202933641, 1450755685155363, 145930618882430, 1459747570939968, 1482351465350198, 149829238430713, 1519856064948500, 1562464497303561, 173955149455632, 198812000402, 234877673256809, 258941513699, 261039940586093, 269993129865393, 277030342456725, 307688779325497, 322739367839522, 353924261385391, 376344085771485, 396795520381965, 405199642913939, 407889119354319, 461654403900239, 484970471577531, 49852438689, 511808655562689, 525243884184515, 527731407332180, 533522990127878, 544053285683692, 554468308013797, 605579839502285, 606676766022011, 663419033716761, 6665038402, 684466768336969, 747130848662418, 771257532932834, 782938198415086, 876613622381314]}])
                t = tf.Tfidf_transform(input_feature="likeids",output_feature="tfidf")
                transformers = [("tfidf",t)]
                p = Pipeline(transformers)
                df2 = p.fit_transform(df)
                self.assertAlmostEqual(df2["tfidf"][0][u"1405744859651437"],0.174077655956)
                joblib.dump(p,"/tmp/p")
                p2 = joblib.load("/tmp/p")
                df3 = p2.transform(df)
        

    def test_list_input_feature(self):
                df = pd.DataFrame([{"likeids": [102313626475894, 110544635673389, 125327794232468, 1381292875499997, 1405744859651437, 1410444839224829, 143981935773732, 1461778597368720, 159634840722133, 1606136206319782, 1617969055108441, 175338329150218, 208633805894647, 244944385603396, 245732105485076, 264050273731539, 302410296457933, 316001081653, 379092115616379, 388308794577146, 430801740267217, 446108528831354, 447497665393027, 450086458346414, 470402606305707, 488128054598370, 508960455844413, 518468471599787, 56531631380, 67920382572, 7310480740, 863556617025433, 943587665656008],},{"likeids": [100318233349756, 111541275541080, 118478001539872, 1392733037644503, 14202933641, 1450755685155363, 145930618882430, 1459747570939968, 1482351465350198, 149829238430713, 1519856064948500, 1562464497303561, 173955149455632, 198812000402, 234877673256809, 258941513699, 261039940586093, 269993129865393, 277030342456725, 307688779325497, 322739367839522, 353924261385391, 376344085771485, 396795520381965, 405199642913939, 407889119354319, 461654403900239, 484970471577531, 49852438689, 511808655562689, 525243884184515, 527731407332180, 533522990127878, 544053285683692, 554468308013797, 605579839502285, 606676766022011, 663419033716761, 6665038402, 684466768336969, 747130848662418, 771257532932834, 782938198415086, 876613622381314]}])
                t = tf.Tfidf_transform(input_feature="likeids",output_feature="tfidf")
                t.fit(df)
                df2 = t.transform(df)
                self.assertAlmostEqual(df2["tfidf"][0][u"1405744859651437"],0.174077655956)

    def test_chi_sq(self):
                df = pd.DataFrame([{"likeids": [102313626475894, 110544635673389, 125327794232468, 1381292875499997, 1405744859651437, 1410444839224829, 143981935773732, 1461778597368720, 159634840722133, 1606136206319782, 1617969055108441, 175338329150218, 208633805894647, 244944385603396, 245732105485076, 264050273731539, 302410296457933, 316001081653, 379092115616379, 388308794577146, 430801740267217, 446108528831354, 447497665393027, 450086458346414, 470402606305707, 488128054598370, 508960455844413, 518468471599787, 56531631380, 67920382572, 7310480740, 863556617025433, 943587665656008],"target":1},{"likeids": [100318233349756, 111541275541080, 118478001539872, 1392733037644503, 14202933641, 1450755685155363, 145930618882430, 1459747570939968, 1482351465350198, 149829238430713, 1519856064948500, 1562464497303561, 173955149455632, 198812000402, 234877673256809, 258941513699, 261039940586093, 269993129865393, 277030342456725, 307688779325497, 322739367839522, 353924261385391, 376344085771485, 396795520381965, 405199642913939, 407889119354319, 461654403900239, 484970471577531, 49852438689, 511808655562689, 525243884184515, 527731407332180, 533522990127878, 544053285683692, 554468308013797, 605579839502285, 606676766022011, 663419033716761, 6665038402, 684466768336969, 747130848662418, 771257532932834, 782938198415086, 876613622381314],"target":1}])
                t = tf.Tfidf_transform(input_feature="likeids",output_feature="tfidf",select_features=True,topn_features=2,target_feature="target")
                t.fit(df)
                df2 = t.transform(df)
                print df2
                self.assertAlmostEqual(df2["tfidf"][0][u"943587665656008"],0.174077655956)

        
if __name__ == '__main__':
    logging.basicConfig(format='%(asctime)s : %(levelname)s : %(message)s', level=logging.INFO)
    unittest.main()

